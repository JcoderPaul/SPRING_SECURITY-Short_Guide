### Вариант 2. - Установка и настройка KeyCloak в Docker контейнере (под Windows OS, development mode).
________________________________________________________________________________________________________________________
Ссылки:
- [https://www.keycloak.org/](https://www.keycloak.org/) ;
- Варианты загрузки - [https://www.keycloak.org/downloads](https://www.keycloak.org/downloads) ;
- [KeyCloak на GitHub](https://github.com/keycloak/keycloak) ;
- [OAuth Grant Types](https://oauth.net/2/grant-types/)
- [KeyCloak Server Administration Guide](https://www.keycloak.org/docs/latest/server_admin/index.html);
________________________________________________________________________________________________________________________
### Способ 1 - Развертка KeyCloak в Docker контейнере, как "вещь в себе".

Мы уже настраивали KeyCloak на локальной машине и видели структуру его пакетов и место, где хранятся настройки сервиса.
В данной ситуации такой вариант развертывания кажется простым и логичным - ведь так предложили разработчики продукта сами.
По этому при настройке сервиса KeyCloak в Docker контейнера мы можем применить такой же способ - "все" в одном контейнере.
Под "все" мы понимаем БД realm-ов, client-ов и пользователей, т.е. они в одном из вариантов будут находиться в том же 
пакете, что и локальной развертке на PC. 

Для этого нам нужен только один контейнер.

- Шаг 1. - Делаем экспорт данных из нашей уже настроенной на PC версии KeyCloak в папку keycloak. Необходимо зайти в 
локальную версию под "админиской учеткой" и перейти в master realm - именно отсюда мы экспортируем все данные. Заходим в 
раздел Realm settings:

![KeyCloak_export_data](DOC/pic/27_KeyCloak_export_data.jpg)

Далее выбираем сохранить все доступные данные:

![KeyCloak_export_include_all](DOC/pic/28_KeyCloak_export_include_all.jpg)

Указываем папку куда сохраняем данные и либо меняем имя *.JSON файла, либо оставляем как есть и жмем "Save". Теперь у нас 
есть, то что мы импортируем в пустой KeyCloak развернутый в Docker-e и не будем тратить время на основную настройку.

- Шаг 2. - Разворачиваем KeyCloak в Docker контейнере используя преднастроенный compose.yml. Пароль и логин admin в нем 
прописаны сразу. Сделаем все максимально просто и "без изысков" с возможностью передачи оных через параметры окружения. 
Основная особенность это место нахождения файла импорта данных - в той же папке где и docker compose файл, в подпапке 
./keycloak. Запускаем 
    
            docker compose up

и ждем окончания процесса развертывания. Порт мы сохранили, как был - 9100 (пробросили его из контейнера), что и у 
локальной версии нашего KeyCloak-a, по этому на время "гасим" его работу, чтобы не было конфликта.

- Шаг 3. - Запускаем наш контейнер с KeyCloak и обращаемся к нему, как и раньше по адресу:

            http://localhost:9100

В предложенной форме авторизуемся "под админской учеткой", т.е. логин/пароль (admin/admin). Если все прошло нормально, то 
мы получаем доступ к KeyCloak-у с уже импортированными настройками. Останется только добавить пользователей.

- Шаг 4. - Тестируем наше приложение в связке с KeyCloak. Работает...

________________________________________________________________________________________________________________________
### Способ 2 - Развертка KeyCloak в Docker контейнере в связке с PostgreSQL (Keycloak on Quarkus, not WildFly/JBoss).

Сначала нам нужно вспомнить базовую структуру файла Docker Compose. Обычно он включает определение служб, сетей и томов.
Для Keycloak сервиса и PostgreSQL базы данных нужны две службы (service), пусть одна будет "keycloak", а другая "postgres" 
(фактически - два контейнера):
- "postgres" - с установленной БД, и заданными пользователем и паролем. Их можно настроить через переменные среды (или 
задать жестко) в docker compose файле; 
- "keycloak" - с установленным сервисом, которому необходимо подключиться к экземпляру PostgreSQL в другом контейнере, 
поэтому ему потребуются те же учетные данные к БД. Кроме того, переменные среды "keycloak" должны указывать на сервис 
"postgres";
- network - создадим для них пользовательскую сеть (хотя и по умолчанию все будет работать), обе службы должны находиться 
в одной сети Docker, чтобы взаимодействовать друг с другом, используя просто имена service-ов;
- volumes - для хранения данных PostgreSQL нам нужно внешнее хранилище, не зависящее от наличия контейнера. Volume позволяет 
избежать потери данных при остановке контейнера или его удалении.

Keycloak-у нужны начальные настройки, такие как имя пользователя и пароль администратора, их можно задать через переменные 
среды или жестко в файле. Поскольку нам нужен доступ к Keycloak, потребуется сопоставление портов ("пробростка" портов во 
вне) для доступа к консоли администратора с хост-машины.

Желательно определиться с версиями образов для Keycloak и Postgres - используем официальные см. док. Обязательно отследить 
версии для полной стыковки программ. Перепроверяем и убеждаемся, что: переменные среды Postgres и Keycloak совпадают (имя БД, 
пользователь, пароль), конфигурация сети.

Особенность данной связки в том, что Keycloak должен запускаться только после запуска и начала работы Postgres. 

Переменные среды для обеих служб: 
- Postgres использует POSTGRES_DB, POSTGRES_USER, POSTGRES_PASSWORD. 
- Keycloak в зависимости от версии, до 17 использовал DB_VENDOR (postgres), DB_ADDR (имя службы), DB_DATABASE, DB_USER, DB_PASSWORD, 
KEYCLOAK_ADMIN и KEYCLOAK_ADMIN_PASSWORD и т.д. От 17 и более поздние версии приобрели префикс KC_* и немного изменили синтаксис 
KC_DB, KC_DB_URL, KC_DB_USERNAME, KC_DB_PASSWORD и т.д.

И так, в зависимости от образа KeyCloak (старый или новый), будут по-разному именоваться и переменные окружения. При конфигурировании 
docker compose файла или изучении уже готового не лишним будет обратиться к официальной документации - ["Запуск Keycloak в контейнере"](https://www.keycloak.org/server/containers).

Исходя из выше изложенных условий мы сконфигурировали compose.yml файл, который разворачивает два контейнера в одной сети
и настраивает взаимодействие между ними. Тут действия, как и в первом способе, после того, как контейнеры уже запущены 
(адреса мы оставили теми же):
- Шаг 1. - Импортируем доступные данные из realm-export.json.
- Шаг 2. - Генерируем и копируем Client Secret в application.yml.
- Шаг 3. - Добавляем пользователей для тестирования нашего приложения в настройки KeyCloak.
- Шаг 4. - Запускаем наше приложение и, через кнопку "Login with KeyCloak", добавленную в нашу форму аутентификации - login.html, 
проверяем работу KeyCloak сервиса.

Для изучения структуры PostgeSQL БД развернутой в docker контейнере и внесенных нами записей можно обратиться по известному адресу 
из любого доступного DB-Viewer-a.